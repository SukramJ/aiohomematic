name: Release on tag
# yamllint disable-line rule:truthy
on:
  push:
    tags:
      - '**'

permissions:
  contents: write

jobs:
  create_release:
    name: Create GitHub Release from changelog
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Determine version from tag
        id: vars
        run: |
          TAG_NAME="${GITHUB_REF_NAME}"
          # Strip a leading 'v' to map tags like v1.2.3 -> 1.2.3
          VERSION="${TAG_NAME#v}"
          echo "TAG_NAME=${TAG_NAME}" >> "$GITHUB_ENV"
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "Tag: $TAG_NAME -> $VERSION"

      - name: Extract release notes from changelog.md
        id: notes
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f changelog.md ]; then
            echo "changelog.md not found at repo root" >&2
            exit 1
          fi

          # Extract the section that starts at the matching header and ends before the next header
          # Header format expected: "# Version <version> (YYYY-MM-DD)"
          # NOTE: We intentionally skip the header line itself from the release notes.
          awk -v ver="${VERSION}" '
            /^# Version / {
              if (insec) exit
              if ($0 ~ "^# Version " ver " ") { insec=1; next }
            }
            insec { print }
          ' changelog.md > RELEASE_NOTES.md || true

          if [ ! -s RELEASE_NOTES.md ]; then
            echo "No matching section found in changelog.md for version '${VERSION}'." >&2
            echo "Expected a line starting with: '# Version ${VERSION} '" >&2
            echo "Aborting release creation." >&2
            exit 1
          fi

          # Determine previous version as the next header following the current version section start
          awk -v ver="${VERSION}" '
            $0 ~ "^# Version " ver " " { insec=1; next }
            insec && /^# Version / {
              if (match($0, /^# Version ([^ ]+)/, m)) { print m[1]; exit }
            }
          ' changelog.md > PREV_VERSION.txt || true

          if [ ! -s PREV_VERSION.txt ]; then
            echo "Could not determine previous version from changelog.md following '${VERSION}'." >&2
            exit 1
          fi
          PREV_VERSION="$(cat PREV_VERSION.txt)"

          # Append Full Changelog link as the last line of the release notes
          REPO="${GITHUB_REPOSITORY}"
          FULL_LINK="**Full Changelog**: https://github.com/${REPO}/compare/${PREV_VERSION}...${VERSION}"
          # Avoid duplicates if rerun
          if ! grep -Fxq "$FULL_LINK" RELEASE_NOTES.md; then
            printf "\n%s\n" "$FULL_LINK" >> RELEASE_NOTES.md
          fi

          echo "Extracted release notes:" >&2
          sed -n '1,40p' RELEASE_NOTES.md >&2

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: ${{ env.TAG_NAME }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger python-publish workflow via repository_dispatch
        run: |
          set -euo pipefail
          REPO="${GITHUB_REPOSITORY}"
          API="https://api.github.com/repos/${REPO}/dispatches"
          echo "Dispatching event 'release-on-tag-succeeded' for tag ${TAG_NAME}"
          curl -sSf -X POST "${API}" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"event_type\":\"release-on-tag-succeeded\",\"client_payload\":{\"tag\":\"${TAG_NAME}\",\"version\":\"${VERSION}\"}}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
