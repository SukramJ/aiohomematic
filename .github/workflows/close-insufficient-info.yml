name: Close Issue - Insufficient Information

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to close'
        required: true
        type: number

permissions:
  issues: write
  contents: read

jobs:
  close-issue:
    if: github.repository_owner == 'SukramJ'
    runs-on: ubuntu-latest
    steps:
      - name: Close issue with comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ github.event.inputs.issue_number }};

            // Fetch the issue to get its body
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            // Detect language based on German-specific labels in the issue body
            const isGerman = issue.body &&
              (issue.body.includes('Das Problem') ||
               issue.body.includes('Diagnoseinformationen') ||
               issue.body.includes('Protokolldatei'));

            // Compose the comment based on language
            let comment;
            if (isGerman) {
              comment = `Dieses Issue wird geschlossen, da die bereitgestellten Informationen nicht ausreichen, um das Problem zu analysieren.

            Ohne eine **Integrationsdiagnose** (.json-Datei) und ein **Debug-Log** ist es uns nicht m√∂glich, die Ursache des Problems zu identifizieren. Diese Daten sind unverzichtbar, da sie die Systemkonfiguration, den Zustand der Ger√§te und die genaue Fehlersequenz dokumentieren.

            **N√§chste Schritte:**
            - Bitte lies [Warum sind Diagnosedaten und Logs so wichtig?](https://sukramj.github.io/aiohomematic/contributor/testing/debug_data_importance/)
            - Erstelle ein neues Issue mit vollst√§ndigen Diagnosedaten, falls das Problem weiterhin besteht

            üí° **Tipp:** Bei Ger√§teproblemen (fehlende Entit√§ten, falsche Werte, seltsames Verhalten) sind Screenshots viel hilfreicher als lange Textbeschreibungen!

            **Hilfreiche Dokumentation:**
            - [Dokumentation](https://sukramj.github.io/aiohomematic/)
            - [Fehlerbehebung](https://sukramj.github.io/aiohomematic/user/troubleshooting/homeassistant_troubleshooting/)
            - [FAQs](https://github.com/sukramj/homematicip_local#frequently-asked-questions)
            - [Glossar](https://sukramj.github.io/aiohomematic/reference/glossary/)
            - [Versionshinweise](https://github.com/sukramj/homematicip_local/releases)

            Wir helfen gerne, sobald die erforderlichen Informationen vorliegen.`;
            } else {
              comment = `This issue is being closed because the information provided is insufficient to analyze the problem.

            Without an **integration diagnostics** file (.json) and a **debug log**, we cannot identify the root cause of the issue. These data are essential as they document the system configuration, device states, and the exact error sequence.

            **Next steps:**
            - Please read [Why are diagnostics and logs so important?](https://sukramj.github.io/aiohomematic/contributor/testing/debug_data_importance/)
            - Open a new issue with complete diagnostic data if the problem persists

            üí° **Tip:** For device-related issues (missing entities, wrong values, strange behavior), screenshots are much more helpful than long text descriptions!

            **Helpful documentation:**
            - [Documentation](https://sukramj.github.io/aiohomematic/)
            - [Troubleshooting](https://sukramj.github.io/aiohomematic/user/troubleshooting/homeassistant_troubleshooting/)
            - [FAQs](https://github.com/sukramj/homematicip_local#frequently-asked-questions)
            - [Glossary](https://sukramj.github.io/aiohomematic/reference/glossary/)
            - [Release notes](https://github.com/sukramj/homematicip_local/releases)

            We're happy to help once the required information is available.`;
            }

            // Post the comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });

            // Close the issue as "not planned"
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'not_planned'
            });

            console.log(`Issue #${issueNumber} closed as "not planned" with ${isGerman ? 'German' : 'English'} comment.`);
