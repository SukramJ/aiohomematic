name: Close Issue - Insufficient Information

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to close'
        required: true
        type: number

permissions:
  issues: write
  contents: read

jobs:
  close-issue:
    if: github.repository_owner == 'SukramJ'
    runs-on: ubuntu-latest
    steps:
      - name: Close issue with comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ github.event.inputs.issue_number }};

            // Fetch the issue to get its body
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            // Detect language based on German-specific labels in the issue body
            const isGerman = issue.body &&
              (issue.body.includes('Das Problem') ||
               issue.body.includes('Diagnoseinformationen') ||
               issue.body.includes('Protokolldatei'));

            // Compose the comment based on language
            let comment;
            if (isGerman) {
              comment = `Dieses Issue wird geschlossen, da die bereitgestellten Informationen nicht ausreichen, um das Problem zu analysieren.

            Ohne eine **Integrationsdiagnose** (.json-Datei) und ein **Debug-Log** ist es uns nicht möglich, die Ursache des Problems zu identifizieren. Diese Daten sind unverzichtbar, da sie die Systemkonfiguration, den Zustand der Geräte und die genaue Fehlersequenz dokumentieren.

            **Nächste Schritte:**
            - Bitte lies [Warum sind Diagnosedaten und Logs so wichtig?](https://github.com/SukramJ/aiohomematic/blob/devel/docs/debug_data_importance.md)
            - Erstelle ein neues Issue mit vollständigen Diagnosedaten, falls das Problem weiterhin besteht

            Wir helfen gerne, sobald die erforderlichen Informationen vorliegen.`;
            } else {
              comment = `This issue is being closed because the information provided is insufficient to analyze the problem.

            Without an **integration diagnostics** file (.json) and a **debug log**, we cannot identify the root cause of the issue. These data are essential as they document the system configuration, device states, and the exact error sequence.

            **Next steps:**
            - Please read [Why are diagnostics and logs so important?](https://github.com/SukramJ/aiohomematic/blob/devel/docs/debug_data_importance.md)
            - Open a new issue with complete diagnostic data if the problem persists

            We're happy to help once the required information is available.`;
            }

            // Post the comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });

            // Close the issue as "not planned"
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'not_planned'
            });

            console.log(`Issue #${issueNumber} closed as "not planned" with ${isGerman ? 'German' : 'English'} comment.`);
